<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Associer siège à vol</title>
    <link rel="shortcut icon" th:href="@{/assets/compiled/svg/favicon.svg}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/assets/compiled/css/app.css}">
    <link rel="stylesheet" th:href="@{/assets/compiled/css/app-dark.css}">
    <link rel="stylesheet" th:href="@{/assets/compiled/css/iconly.css}">
</head>
<body>
<script src="/assets/static/js/initTheme.js"></script>
<div id="app">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    <div id="main">
        <header class="mb-3">
            <a href="#" class="burger-btn d-block d-xl-none">
                <i class="bi bi-justify fs-3"></i>
            </a>
        </header>
        <div class="page-heading">
            <div class="page-title">
                <div class="row">
                    <div class="col-12 col-md-6 order-md-1 order-last">
                        <h3>Associer siège à vol</h3>
                        <p class="text-subtitle text-muted">Créer un siège-vol (LIBRE) pour un vol donné</p>
                    </div>
                    <div class="col-12 col-md-6 order-md-2 order-first">
                        <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/home">fly</a></li>
                                <li class="breadcrumb-item"><a href="/avions">Avion</a></li>
                                <li class="breadcrumb-item" aria-current="page">Sièges-Vol</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-content">
            <section class="row">
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h4>Associer</h4>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/sieges/associer-range}" method="post" class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Vol instance</label>
                                    <select class="form-select" name="idVolInstance" id="viSelect" required>
                                        <option value="" disabled selected>Choisir...</option>
                                        <option th:each="vi : ${volInstances}" th:value="${vi.idVolInstance}"
                                                th:text="${#temporals.format(vi.dateDepart, 'yyyy-MM-dd HH:mm')} + ' - ' + ${vi.vol.compagnie.nom}"></option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Numéro départ</label>
                                    <input type="number" class="form-control" name="startNumero" id="startNumero" min="0" required placeholder="Ex: 1">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Numéro fin</label>
                                    <input type="number" class="form-control" name="endNumero" id="endNumero" min="0" required placeholder="Ex: 30">
                                </div>
                                <div class="col-12">
                                    <small class="text-muted">Nombre de sièges à associer: <span id="rangeCount">0</span></small>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">Associer la plage</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h4>Sièges de l'avion sélectionné</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Total sièges: <span id="siegeTotal">0</span></small>
                                <input type="text" class="form-control form-control-sm" id="siegeFilter" placeholder="Filtrer par classe ou numéro" style="max-width: 240px;">
                            </div>
                            <div class="table-responsive" style="max-height: 380px; overflow:auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Numéro</th>
                                            <th>Classe</th>
                                        </tr>
                                    </thead>
                                    <tbody id="siegeList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<script th:inline="javascript">
    (function(){
        const startEl = document.getElementById('startNumero');
        const endEl = document.getElementById('endNumero');
        const countEl = document.getElementById('rangeCount');
        const viSelect = document.getElementById('viSelect');
        const siegeListEl = document.getElementById('siegeList');
        const siegeTotalEl = document.getElementById('siegeTotal');
        const siegeFilterEl = document.getElementById('siegeFilter');

        // Mapping volInstance -> avionId
        const volInstanceToAvion = {
            /*[# th:each="vi : ${volInstances}"]*/
            [[${vi.idVolInstance}]]: [[${vi.avion != null ? vi.avion.idAvion : 0}]],
            /*[/]*/
        };
        // All seats with their avionId, numero and classe
        const siegesData = [
            /*[# th:each="s : ${sieges}"]*/
            { id:[[${s.idSiege}]], numero:'[[${s.numero}]]', classe:'[[${s.classe}]]', avionId:[[${s.avion != null ? s.avion.idAvion : 0}]] },
            /*[/]*/
        ];

        function updateCount(){
            const s = parseInt(startEl.value, 10);
            const e = parseInt(endEl.value, 10);
            if(!isNaN(s) && !isNaN(e) && e >= s){
                countEl.textContent = (e - s + 1).toString();
            } else {
                countEl.textContent = '0';
            }
        }
        function renderSieges(){
            const selectedVi = parseInt(viSelect.value, 10);
            const avionId = volInstanceToAvion[selectedVi] || 0;
            const q = (siegeFilterEl.value || '').toLowerCase().trim();
            const rows = siegesData
                .filter(s => s.avionId === avionId)
                .filter(s => !q || s.classe.toLowerCase().includes(q) || s.numero.toLowerCase().includes(q))
                .sort((a,b) => {
                    const na = parseInt(a.numero, 10);
                    const nb = parseInt(b.numero, 10);
                    if(!isNaN(na) && !isNaN(nb)) return na - nb;
                    return a.numero.localeCompare(b.numero);
                })
                .map(s => `<tr><td>${s.numero}</td><td>${s.classe}</td></tr>`)
                .join('');
            siegeListEl.innerHTML = rows;
            siegeTotalEl.textContent = siegesData.filter(s => s.avionId === avionId).length.toString();
        }
        startEl.addEventListener('input', updateCount);
        endEl.addEventListener('input', updateCount);
        viSelect.addEventListener('change', renderSieges);
        siegeFilterEl.addEventListener('input', renderSieges);
        // Initial render if a vol instance is preselected
        if(viSelect.value){ renderSieges(); }
    })();
</script>
</body>
</html>
